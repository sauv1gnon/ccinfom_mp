name: geo_services_module

networks:
  geo_services:
    driver: bridge

services:
#================== Geo Services ==================
  ors-app:
    container_name: ors-app
    restart: unless-stopped
    ports:
      - "${ORS_HTTP_PORT:-8080}:8080"  # ORS API on dedicated host port
      - "9001:9001"  # Additional port for monitoring (optional)
    image: openrouteservice/openrouteservice:latest
    volumes:
      - ./ors/ors-config.yml:/home/ors/config/ors-config.yml
      - ./data/philippines.osm.pbf:/home/ors/files/philippines.osm.pbf
      - ./ors/graphs:/home/ors/graphs
      - ./ors/elevation_cache:/home/ors/elevation_cache
      - ./ors/logs:/home/ors/logs
    environment:
      REBUILD_GRAPHS: ${ORS_REBUILD_GRAPHS:-false}  # Set to true to rebuild graphs on container start.
      CONTAINER_LOG_LEVEL: INFO  # Log level for the container. Possible values: DEBUG, INFO, WARNING, ERROR, CRITICAL
      ORS_CONFIG_LOCATION: /home/ors/config/ors-config.yml  # Explicit config path inside the container.
      XMS: ${ORS_XMS:-4g}  # start RAM assigned to java
      XMX: ${ORS_XMX:-8g}  # max RAM assigned to java. Rule of Thumb: <PBF-size> * <profiles> * 2
      # Example: 1.5 GB pbf size, two profiles (car and foot-walking)
      # -> 1.5 * 2 * 2 = 6. Set xmx to be AT LEAST `-Xmx6g`
      ADDITIONAL_JAVA_OPTS: "${ORS_JAVA_OPTS:-}"  # further options you want to pass to the java command
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/ors/v2/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - geo_services

  nominatim:
    container_name: nominatim
    image: mediagis/nominatim:5.1
    restart: unless-stopped
    ports:
      - "${NOMINATIM_HTTP_PORT:-8081}:8083"
    environment:
      NOMINATIM_PASSWORD: ${NOMINATIM_PASSWORD:-change_me}
      IMPORT_PBF: /nominatim/input/philippines.osm.pbf
      PBF_PATH: /nominatim/input/philippines.osm.pbf
      REPLICATION_URL: ${NOMINATIM_REPLICATION_URL:-https://download.geofabrik.de/asia/philippines-updates/}
      NOMINATIM_THREADS: ${NOMINATIM_THREADS:-8}
      NOMINATIM_IMPORT_WIKIPEDIA: ${NOMINATIM_IMPORT_WIKIPEDIA:-false}
      NOMINATIM_FLATNODE_FILE: /nominatim/flatnode/flatnode.file
    volumes:
      - nominatim-data:/var/lib/postgresql/16/main
      - nominatim-flatnode:/nominatim/flatnode
      - ./data/philippines.osm.pbf:/nominatim/input/philippines.osm.pbf
      - ./nominatim/local.php:/etc/nominatim/local.php
    shm_size: 1gb
    healthcheck:
      test: ["CMD", "bash", "-c", "curl -fsS http://localhost:8083/status.php || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s
    networks:
      - geo_services
  
  tileserver:
    container_name: tileserver
    image: maptiler/tileserver-gl
    restart: unless-stopped
    ports:
      - "${TILESERVER_HTTP_PORT:-8082}:80"
    volumes:
      - "./data/philippines.mbtiles:/data/philippines.mbtiles:ro"
      - "./tileserver/config:/etc/tileserver:ro"
    command: ["-p", "80", "-c", "/etc/tileserver/config.json"]
    environment:
      TILESERVER_CACHE_SIZE: ${TILESERVER_CACHE_SIZE:-512MB}
      TILESERVER_MAX_THREADS: ${TILESERVER_MAX_THREADS:-8}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - geo_services

volumes:
  nominatim-data:
  nominatim-flatnode: